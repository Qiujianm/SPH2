# Hysteria2 流量监控系统使用手册

## 概述
Hysteria2 流量监控系统是为 Hysteria2 代理服务设计的全面网络流量监控解决方案，提供实时监控、历史统计、连接分析等功能。

## 功能特性

### 1. 实时监控
#### 1.1 实时网卡流量监控
- **功能说明**：监控系统所有网卡的实时流量
- **显示内容**：
  - 下载速率（实时）
  - 上传速率（实时）
  - 累计下载流量
  - 累计上传流量
- **更新频率**：1秒
- **使用场景**：查看整体网络活动，诊断网络问题

#### 1.2 实时端口流量监控
- **功能说明**：监控每个 Hysteria2 实例端口的实时流量
- **技术实现**：基于 iptables 规则统计
- **显示内容**：
  - 端口号
  - 活动连接数
  - 下载速率
  - 上传速率
  - 服务状态
- **更新频率**：1秒
- **注意事项**：
  - 会自动在 iptables 中添加统计规则
  - 退出时自动清理规则
  - 防火墙重启后计数器会重置

### 2. 统计分析
#### 2.1 按端口流量统计
- **功能说明**：静态统计各端口的连接情况
- **显示内容**：
  - 端口号
  - 活动连接数
  - 监听状态
  - 配置文件存在性
- **适用场景**：快速检查各端口运行状态

#### 2.2 连接统计详情
- **功能说明**：深入分析特定端口的连接详情
- **支持功能**：
  - 查看单个端口
  - 查看所有端口
- **统计信息**：
  - 总连接数
  - 连接状态分布（ESTABLISHED, TIME_WAIT 等）
  - Top 10 连接来源 IP
- **使用场景**：排查异常连接，识别高频用户

#### 2.3 Top 流量使用者
- **功能说明**：跨所有端口汇总，找出连接最多的 IP
- **显示内容**：
  - IP 地址
  - 总连接数
  - 涉及的端口列表
- **显示数量**：Top 20
- **使用场景**：
  - 识别重度用户
  - 检测异常流量
  - 流量成本分析

### 3. 历史与报表
#### 3.1 流量历史统计
- **功能说明**：查看历史流量记录
- **时间范围选项**：
  - 最近 24 小时
  - 最近 7 天
  - 最近 30 天
  - 全部历史
- **数据来源**：自动收集的流量数据文件
- **前置条件**：需先启用自动数据收集

#### 3.2 自动数据收集
- **功能说明**：定期自动收集网卡流量数据
- **收集频率**：每小时
- **存储位置**：`/var/log/hysteria/traffic/traffic_history.log`
- **实现方式**：
  - cron 定时任务
  - 数据收集脚本：`/usr/local/bin/hysteria-traffic-collector.sh`
- **数据保留**：自动清理 30 天前的数据

#### 3.3 生成流量报表
- **功能说明**：生成全面的流量监控报告
- **报表内容**：
  - 系统信息（主机名、系统版本、运行时间）
  - 网卡流量统计
  - Hysteria2 实例统计
  - 系统资源使用情况（CPU、内存、磁盘）
- **导出格式**：文本文件
- **文件命名**：`traffic_report_YYYYMMDD_HHMMSS.txt`
- **存储位置**：`/root/`

### 4. 系统管理
#### 4.1 清理监控规则
- **功能说明**：手动清理 iptables 流量统计规则
- **使用场景**：
  - 不再需要实时监控时
  - 释放 iptables 资源
  - 避免规则累积

## 使用指南

### 启动流量监控系统
从主菜单进入：
```bash
cd /root/hysteria
./main.sh
# 选择 "7. 流量监控"
```

或直接运行：
```bash
cd /root/hysteria
./monitor.sh
```

### 典型使用场景

#### 场景1: 日常流量监控
1. 启用自动数据收集（首次使用）
2. 使用实时网卡监控查看整体流量
3. 定期生成流量报表

#### 场景2: 性能问题排查
1. 使用实时端口监控定位高流量端口
2. 查看该端口的连接统计详情
3. 分析 Top 流量使用者

#### 场景3: 安全审计
1. 查看 Top 流量使用者
2. 检查连接统计详情中的异常 IP
3. 生成完整流量报表存档

#### 场景4: 历史数据分析
1. 查看流量历史统计
2. 选择时间范围（如最近 7 天）
3. 分析流量趋势

## 技术细节

### 网卡流量统计实现
- 读取 `/sys/class/net/[interface]/statistics/` 中的统计数据
- 计算相邻时间点的差值得到速率
- 不需要额外权限

### 端口流量统计实现
- 使用 `iptables` 添加统计规则：
  ```bash
  iptables -I INPUT -p udp --dport [port] -j ACCEPT
  iptables -I OUTPUT -p udp --sport [port] -j ACCEPT
  ```
- 读取规则计数器获取流量数据
- 需要 root 权限

### 连接统计实现
- 使用 `ss` 命令获取 socket 信息
- 支持 TCP 和 UDP 连接
- UDP 连接统计可能不完全准确

### 数据格式
流量历史记录格式：
```
2025-11-05 19:30:00 eth0 RX:1234567890 TX:9876543210
```

## 注意事项

1. **权限要求**：
   - 实时端口监控需要 root 权限（修改 iptables）
   - 其他功能只需读取权限

2. **性能影响**：
   - 实时监控会占用少量 CPU（约 1-2%）
   - iptables 规则对网络性能影响极小

3. **UDP 协议特性**：
   - Hysteria2 使用 UDP 协议
   - UDP 连接统计可能不如 TCP 准确
   - 建议结合多种监控方式

4. **数据持久化**：
   - 自动收集的数据存储在 `/var/log/hysteria/traffic/`
   - 确保该目录有足够磁盘空间
   - 30 天自动清理

5. **防火墙兼容性**：
   - 与现有 iptables 规则兼容
   - 不影响 Hysteria2 正常运行
   - 退出时自动清理临时规则

## 故障排除

### 问题1：无法启动实时端口监控
**可能原因**：
- 没有 root 权限
- iptables 未安装

**解决方法**：
```bash
# 检查权限
whoami
# 应该显示 root

# 检查 iptables
which iptables
```

### 问题2：找不到运行中的实例
**可能原因**：
- Hysteria2 服务未启动
- systemd 服务命名不匹配

**解决方法**：
```bash
# 检查服务状态
systemctl list-units --type=service | grep hysteria

# 启动服务
systemctl start hysteria-server@[port]
```

### 问题3：历史数据为空
**可能原因**：
- 未启用自动数据收集
- cron 服务未运行

**解决方法**：
```bash
# 启用数据收集（在监控菜单中选择选项 8）

# 检查 cron 服务
systemctl status cron

# 手动执行一次收集
/usr/local/bin/hysteria-traffic-collector.sh
```

## 最佳实践

1. **定期备份数据**：
   ```bash
   cp /var/log/hysteria/traffic/traffic_history.log \
      /backup/traffic_$(date +%Y%m%d).log
   ```

2. **设置告警阈值**：
   根据实际情况设置流量告警阈值，可以扩展脚本添加告警功能

3. **结合系统监控**：
   配合 htop、nethogs 等工具进行综合分析

4. **定期生成报表**：
   建议每周生成一次流量报表，用于趋势分析

5. **及时清理规则**：
   长期不使用实时监控时，及时清理 iptables 规则

## 未来扩展

可能的扩展方向：
- Web 界面可视化
- 图表化展示历史数据
- 邮件/微信告警
- 流量配额管理
- API 接口支持
- 更细粒度的统计（每分钟、每秒）

## 技术支持

如遇问题，请检查：
1. 系统日志：`journalctl -u hysteria-server@*`
2. 脚本执行日志
3. iptables 规则：`iptables -L -n -v`

---

**版本**: v1.0  
**更新日期**: 2025-11-05  
**作者**: @Qiujianm  
